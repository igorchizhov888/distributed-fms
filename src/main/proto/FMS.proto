syntax = "proto3";
package com.distributedFMS;
option java_multiple_files = true;
option java_package = "com.distributedFMS.grpc";
option java_outer_classname = "FMSProto";
// The FMS service definition.
service ManagementService {
  // Submits an event to the FMS.
  rpc SubmitEvent (SubmitEventRequest) returns (SubmitEventResponse) {}
}
// The request message containing the event details.
message SubmitEventRequest {
  string event_type = 1;
  string device_id = 2;
  int64 event_time = 3;
  string description = 4;
}
// The response message containing the event ID.
message SubmitEventResponse {
  string event_id = 1;
}
// The Alarm Query service definition.
service AlarmService {
  // Queries for alarms, with optional filtering.
  rpc QueryAlarms (QueryAlarmsRequest) returns (stream AlarmMessage) {}
}
// Mirrors the Alarm.java model
message AlarmMessage {
  string alarm_id = 1;
  int64 timestamp = 2;
  string device_id = 3;
  string severity = 4; // Using string for enum representation (1, 2, or 3)
  string event_type = 5;
  string description = 6;
  string geographic_region = 7;
  string status = 8;
  int32 tally_count = 9;
  int64 first_occurrence = 10;
  int64 last_occurrence = 11;
  string node_alias = 12; // Node identifier/alias
  string probable_cause = 13; // Root cause of the alarm
  string alarm_group = 14; // Alarm category/group
  string summary = 15; // Brief summary of the alarm
  string iid = 16; // Ignite ID (internal cache key)
  string correlation_id = 17; // Correlation group ID
  string root_cause_alarm_id = 18; // Root cause alarm ID in this correlation
}
// Request message for querying alarms.
// All fields are optional; if a field is omitted, it is not used for filtering.
message QueryAlarmsRequest {
  // Optional: Filter by alarm severity.
  optional string severity = 1;
  // Optional: Filter by source device ID.
  optional string device_id = 2;
  // Optional: Filter by event type.
  optional string event_type = 3;
}

// ============================================================================
// TOPOLOGY LEARNING SERVICE (GNN-based)
// ============================================================================

// The Topology Learning service definition.
service TopologyService {
  // Train the GNN model from alarm history
  rpc TrainTopology(TrainTopologyRequest) returns (TrainTopologyResponse) {}
  
  // Train with real alarms from Ignite (NEW)
  rpc TrainTopologyWithAlarms(TrainTopologyRequestWithAlarms) returns (TrainTopologyResponse) {}
  
  // Get the current learned topology
  rpc GetTopology(GetTopologyRequest) returns (GetTopologyResponse) {}
  
  // Predict if two devices are connected
  rpc PredictConnection(PredictConnectionRequest) returns (PredictConnectionResponse) {}
  
  // Get predicted edges for a specific device
  rpc GetDeviceConnections(GetDeviceConnectionsRequest) returns (GetDeviceConnectionsResponse) {}
}

message TrainTopologyRequest {
  int32 alarm_history_hours = 1;  // How many hours of alarm history to use
  int32 num_epochs = 2;            // Number of training epochs
}

message TrainTopologyResponse {
  bool success = 1;
  string message = 2;
  int32 num_nodes = 3;
  int32 num_edges = 4;
  double training_loss = 5;
  string training_timestamp = 6;
}

message GetTopologyRequest {
  double min_confidence = 1;  // Filter edges below this confidence (0.0-1.0)
}

message GetTopologyResponse {
  repeated TopologyNode nodes = 1;
  repeated TopologyEdge edges = 2;
  string topology_timestamp = 3;
  int32 total_nodes = 4;
  int32 total_edges = 5;
}

message TopologyNode {
  string device_id = 1;
  string device_type = 2;           // e.g., "core_router", "edge_router", "host"
  repeated float embedding = 3 [packed=false];     // 128-dimensional node embedding from GNN
}

message TopologyEdge {
  string source_device = 1;
  string destination_device = 2;
  double confidence = 3;             // 0.0-1.0: How confident the model is
  double causality_weight = 4;       // 0.0-1.0: Alarm causality strength
  int32 co_occurrence_count = 5;     // How many times alarms co-occurred
  string last_observed = 6;          // Timestamp of last co-occurrence
}

message PredictConnectionRequest {
  string device_a = 1;
  string device_b = 2;
}

message PredictConnectionResponse {
  bool connected = 1;
  double confidence = 2;
  double causality_weight = 3;
  string explanation = 4;  // Human-readable explanation
}

message GetDeviceConnectionsRequest {
  string device_id = 1;
  double min_confidence = 2;
}

message GetDeviceConnectionsResponse {
  repeated TopologyEdge edges = 1;
  int32 total_connections = 2;
}

// ============================================================================
// ALARM DATA FOR TOPOLOGY TRAINING
// ============================================================================

message AlarmData {
  string device_id = 1;
  int64 timestamp = 2;
  string severity = 3;
  string event_type = 4;
  string description = 5;
}

message TrainTopologyRequestWithAlarms {
  repeated AlarmData alarms = 1;
  repeated string device_ids = 2;
  int32 num_epochs = 3;
}
